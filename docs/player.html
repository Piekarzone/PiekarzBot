<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>WebAudio Sound Player</title>
  <style>
    html, body { margin:0; background:transparent; overflow:hidden }
    #overlay {
      position:absolute; top:0; left:0; width:100%; height:100%;
      background:rgba(0,0,0,0.5); color:#fff;
      display:flex; align-items:center; justify-content:center;
      font-family:sans-serif; font-size:18px; cursor:pointer;
    }
  </style>
</head>
<body>
  <div id="overlay">Kliknij, aby odblokować dźwięk</div>

  <script>
    // Bazowy URL strony GitHub Pages
    const BASE_URL = "https://piekarzone.github.io/PiekarzBot";
    const JSON_URL = `${BASE_URL}/now_playing.json`;

    // Web Audio
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    let unlocked = false;
    let lastTs = 0;

    // overlay do odblokowania audioContext
    const overlay = document.getElementById("overlay");
    overlay.addEventListener("click", async () => {
      if (audioCtx.state === "suspended") {
        await audioCtx.resume();
      }
      unlocked = true;
      overlay.remove();
    });

    // odtwarzanie pliku przez AudioContext
    async function playSound(name, ts) {
      const url = `${BASE_URL}/sounds/${name}.mp3?_=${ts}`;
      const resp = await fetch(url);
      const buf = await resp.arrayBuffer();
      const audioBuf = await audioCtx.decodeAudioData(buf);
      const src = audioCtx.createBufferSource();
      src.buffer = audioBuf;
      src.connect(audioCtx.destination);
      src.start(0);
    }

    // polling JSON
    async function poll() {
      if (!unlocked) return;
      try {
        const res = await fetch(JSON_URL, { cache: "no-store" });
        const { sound, ts } = await res.json();
        if (ts && ts > lastTs) {
          lastTs = ts;
          // obcinamy .mp3 jeśli JSON poda pełną nazwę
          const name = sound.endsWith(".mp3") ? sound.slice(0,-4) : sound;
          playSound(name, ts);
        }
      } catch(e) {
        console.error("Poll error:", e);
      }
    }

    // start pollingu
    setInterval(poll, 1000);
  </script>
</body>
</html>